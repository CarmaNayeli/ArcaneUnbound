<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Arcane Unbound - Coven Combination Rituals</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Garamond', 'Georgia', serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: #e4e4e4;
            padding: 20px;
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            padding: 40px 20px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            margin-bottom: 30px;
            border: 2px solid #8b5cf6;
            box-shadow: 0 0 30px rgba(139, 92, 246, 0.3);
        }

        h1 {
            font-size: 2.5em;
            color: #c084fc;
            text-shadow: 0 0 20px rgba(192, 132, 252, 0.5);
            margin-bottom: 10px;
            letter-spacing: 2px;
        }

        .subtitle {
            font-size: 1.2em;
            color: #a78bfa;
            font-style: italic;
        }

        .loading {
            text-align: center;
            padding: 60px;
            font-size: 1.5em;
            color: #a78bfa;
            font-style: italic;
        }

        .selector-panel {
            background: rgba(0, 0, 0, 0.4);
            border: 2px solid #6366f1;
            border-radius: 10px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 0 20px rgba(99, 102, 241, 0.2);
        }

        .selector-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .member-selector {
            background: rgba(30, 30, 50, 0.5);
            border: 2px solid #4c1d95;
            border-radius: 8px;
            padding: 15px;
            position: relative;
        }

        .remove-member-btn {
            position: absolute;
            top: 8px;
            right: 8px;
            background: rgba(220, 38, 38, 0.8);
            border: 1px solid #dc2626;
            border-radius: 4px;
            color: white;
            cursor: pointer;
            padding: 4px 8px;
            font-size: 0.8em;
            font-weight: bold;
            transition: all 0.2s;
        }

        .remove-member-btn:hover {
            background: rgba(220, 38, 38, 1);
            transform: scale(1.1);
        }

        .member-title {
            color: #fbbf24;
            font-weight: bold;
            margin-bottom: 12px;
            font-size: 1.1em;
            text-align: center;
            border-bottom: 1px solid #6366f1;
            padding-bottom: 8px;
            padding-right: 50px;
        }

        .role-selector {
            display: flex;
            flex-direction: column;
            margin-bottom: 10px;
        }

        .role-selector:last-child {
            margin-bottom: 0;
        }

        label {
            color: #c084fc;
            font-weight: bold;
            margin-bottom: 6px;
            font-size: 0.95em;
        }

        select {
            padding: 12px;
            background: rgba(30, 30, 50, 0.8);
            border: 2px solid #6366f1;
            border-radius: 5px;
            color: #e4e4e4;
            font-size: 1em;
            cursor: pointer;
            transition: all 0.3s;
        }

        select:hover {
            border-color: #8b5cf6;
            background: rgba(40, 40, 60, 0.9);
        }

        select:focus {
            outline: none;
            border-color: #c084fc;
            box-shadow: 0 0 10px rgba(192, 132, 252, 0.5);
        }

        option {
            background: #1a1a2e;
            color: #e4e4e4;
        }

        .clear-button {
            margin-top: 20px;
            padding: 12px 30px;
            background: linear-gradient(135deg, #7c3aed 0%, #5b21b6 100%);
            border: none;
            border-radius: 5px;
            color: white;
            font-size: 1.1em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }

        .clear-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(124, 58, 237, 0.5);
        }

        .results-panel {
            background: rgba(0, 0, 0, 0.4);
            border: 2px solid #6366f1;
            border-radius: 10px;
            padding: 30px;
            min-height: 200px;
        }

        .results-header {
            color: #c084fc;
            font-size: 1.5em;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #6366f1;
        }

        .ritual-card {
            background: rgba(20, 20, 40, 0.6);
            border: 2px solid #8b5cf6;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            transition: all 0.3s;
        }

        .ritual-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 25px rgba(139, 92, 246, 0.4);
            border-color: #c084fc;
        }

        .ritual-card.ai-ritual {
            border-color: #10b981;
            box-shadow: 0 0 15px rgba(16, 185, 129, 0.3);
        }

        .ritual-card.ai-ritual:hover {
            border-color: #34d399;
            box-shadow: 0 5px 25px rgba(16, 185, 129, 0.5);
        }

        .ritual-name {
            color: #fbbf24;
            font-size: 1.4em;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .ai-badge {
            display: inline-block;
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.75em;
            font-weight: bold;
            margin-left: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .ritual-power {
            display: inline-block;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .power-low {
            background: rgba(34, 197, 94, 0.3);
            border: 1px solid #22c55e;
            color: #86efac;
        }

        .power-moderate {
            background: rgba(59, 130, 246, 0.3);
            border: 1px solid #3b82f6;
            color: #93c5fd;
        }

        .power-high {
            background: rgba(168, 85, 247, 0.3);
            border: 1px solid #a855f7;
            color: #d8b4fe;
        }

        .power-very-high {
            background: rgba(236, 72, 153, 0.3);
            border: 1px solid #ec4899;
            color: #fbcfe8;
        }

        .power-supreme {
            background: rgba(239, 68, 68, 0.3);
            border: 1px solid #ef4444;
            color: #fca5a5;
        }

        .power-mythic {
            background: linear-gradient(90deg, rgba(239, 68, 68, 0.3), rgba(168, 85, 247, 0.3));
            border: 1px solid #fbbf24;
            color: #fde047;
            animation: glow 2s infinite;
        }

        @keyframes glow {
            0%, 100% { box-shadow: 0 0 10px rgba(251, 191, 36, 0.5); }
            50% { box-shadow: 0 0 20px rgba(251, 191, 36, 0.8); }
        }

        .ritual-summary {
            color: #d1d5db;
            font-style: italic;
            margin-bottom: 15px;
            font-size: 1.1em;
        }

        .ritual-description {
            color: #e4e4e4;
            line-height: 1.6;
            margin-bottom: 15px;
        }

        .ritual-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid rgba(139, 92, 246, 0.3);
        }

        .detail-item {
            display: flex;
            flex-direction: column;
        }

        .detail-label {
            color: #a78bfa;
            font-size: 0.9em;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .detail-value {
            color: #e4e4e4;
            font-size: 0.95em;
        }

        .risk-warning {
            background: rgba(239, 68, 68, 0.2);
            border: 1px solid #ef4444;
            border-radius: 5px;
            padding: 10px;
            margin-top: 15px;
            color: #fca5a5;
        }

        .risk-warning::before {
            content: "‚ö†Ô∏è ";
            font-weight: bold;
        }

        .no-results {
            text-align: center;
            padding: 60px 20px;
            color: #9ca3af;
            font-size: 1.2em;
            font-style: italic;
        }

        .role-requirement {
            color: #8b5cf6;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .mode-toggle {
            margin-bottom: 20px;
            padding: 20px;
            background: rgba(139, 92, 246, 0.2);
            border: 2px solid #8b5cf6;
            border-radius: 10px;
            display: flex;
            align-items: center;
            gap: 15px;
            box-shadow: 0 0 15px rgba(139, 92, 246, 0.3);
        }

        .mode-toggle label {
            color: #c084fc;
            font-size: 1.2em;
            margin: 0;
            cursor: pointer;
            user-select: none;
            font-weight: bold;
        }

        .toggle-switch {
            position: relative;
            width: 60px;
            height: 30px;
            background: rgba(100, 100, 120, 0.5);
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .toggle-switch.active {
            background: linear-gradient(135deg, #7c3aed 0%, #5b21b6 100%);
        }

        .toggle-slider {
            position: absolute;
            top: 3px;
            left: 3px;
            width: 24px;
            height: 24px;
            background: white;
            border-radius: 50%;
            transition: all 0.3s;
        }

        .toggle-switch.active .toggle-slider {
            left: 33px;
        }

        .tradition-selector {
            display: none;
        }

        .tradition-selector.show {
            display: flex;
            flex-direction: column;
        }

        .mode-description {
            color: #9ca3af;
            font-size: 0.9em;
            font-style: italic;
        }

        @media (max-width: 768px) {
            h1 {
                font-size: 1.8em;
            }

            .selector-grid {
                grid-template-columns: 1fr;
            }

            .member-selector {
                padding: 12px;
            }

            .ritual-details {
                grid-template-columns: 1fr;
            }

            .clear-button {
                min-width: 100% !important;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üåô Coven Combination Rituals üåô</h1>
            <p class="subtitle">Discover the power of your coven's unique composition</p>
            <div style="background: rgba(16, 185, 129, 0.2); border: 1px solid #10b981; padding: 15px; border-radius: 8px; margin-top: 15px; font-size: 0.9em;">
                üí° <strong>Best Experience:</strong> Download this page (File ‚Üí Save As) and open it locally to avoid connection issues!
            </div>
        </header>

        <div id="loadingIndicator" class="loading">
            Loading rituals from the grimoire...
        </div>

        <div id="mainContent" style="display: none;">
            <div class="selector-panel">
                <div class="mode-toggle">
                    <div class="toggle-switch" id="modeToggle" onclick="toggleAdvancedMode()">
                        <div class="toggle-slider"></div>
                    </div>
                    <label for="modeToggle" onclick="toggleAdvancedMode()">
                        <span id="modeLabel">Basic Mode</span>
                        <div class="mode-description" id="modeDescription">Role & Path combinations only</div>
                    </label>
                </div>

                <h2 style="color: #c084fc; margin-bottom: 10px;">Select Your Coven Members</h2>
                <p style="color: #9ca3af; margin-bottom: 20px;">
                    Choose the role AND path for each witch to see available rituals<br>
                    <small style="color: #8b5cf6; font-weight: bold;">üí° Enable Advanced Mode above to select specific Traditions!</small>
                </p>

                <div class="selector-grid" id="roleSelectors">
                    <!-- Member selectors will be dynamically generated -->
                </div>

                <div style="display: flex; gap: 15px; margin-top: 20px; flex-wrap: wrap;">
                    <button class="clear-button" id="addMemberBtn" onclick="addMember()" style="flex: 1; min-width: 200px;">
                        ‚ûï Add Member (2/6)
                    </button>
                    <button class="clear-button" onclick="resetMembers()" style="flex: 1; min-width: 200px; background: linear-gradient(135deg, #dc2626 0%, #991b1b 100%);">
                        üîÑ Reset All
                    </button>
                </div>
            </div>

            <div class="results-panel">
                <h2 class="results-header">Available Rituals</h2>
                <div id="ritualResults">
                    <div class="no-results">
                        Select coven roles above to see available combination rituals...
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Supabase configuration
        const SUPABASE_URL = 'https://whmhaktrfkvclcsbhqdt.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndobWhha3RyZmt2Y2xjc2JocWR0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM0ODQ0MjIsImV4cCI6MjA3OTA2MDQyMn0.zVKhBpFzLjlra8wDHWtTrj_amRB-4ZC_sTPSbzXwf1E';

        // Easter egg state
        let threadUnlocked = false;
        let typedString = '';
        let lastTypedTime = Date.now();

        const roles = [
            "High Priestess",
            "Keeper",
            "Seeker",
            "Hand",
            "Voice",
            "Hearth"
        ];

        const paths = [
            "Crafter",
            "Weaver",
            "Medium",
            "Channeler",
            "Shapechanger",
            "Warden"
        ];

        const traditions = {
            "Crafter": [
                { name: "Songbird", summary: "Sound and resonance magic through music" },
                { name: "Nourishers", summary: "Magic through consumption and grown things" },
                { name: "Ritualists", summary: "Prepared enchanted objects" },
                { name: "Binders", summary: "Knots, ties, and sympathetic connections" },
                { name: "Shapers", summary: "Transform raw materials into magical objects" },
                { name: "Inscribers", summary: "Marking and symbolism magic" }
            ],
            "Weaver": [
                { name: "Oracle", summary: "Divination tools (tarot, bones, runes)" },
                { name: "Augur", summary: "Read natural signs and omens" },
                { name: "Chronologist", summary: "Time and temporal manipulation" },
                { name: "Pattern Seeker", summary: "Mathematics and logical fate" },
                { name: "Invoker", summary: "Petition higher powers" },
                { name: "Synchronist", summary: "Meaningful coincidence and chaos" }
            ],
            "Medium": [
                { name: "Death Keeper", summary: "Connect with the dead" },
                { name: "Demon Broker", summary: "Negotiate with infernal entities" },
                { name: "Fae-Touched", summary: "Deal with the fair folk" },
                { name: "Spirit Guide", summary: "Dedicated protective spirit" },
                { name: "Vessel", summary: "Allow entity possession" },
                { name: "Familiar Keeper", summary: "Magical animal companion bond" }
            ],
            "Channeler": [
                { name: "Elementalist", summary: "Classical elements (fire, water, air, earth)" },
                { name: "Force Witch", summary: "Natural laws and planetary forces" },
                { name: "Psychic", summary: "Mental energy and telepathy" },
                { name: "Luminary", summary: "Light and darkness" },
                { name: "Soul Shaper", summary: "Spiritual energy and life force" },
                { name: "Void Caller", summary: "Entropy and nothingness" }
            ],
            "Shapechanger": [
                { name: "Glamourist", summary: "Illusion and appearance changes" },
                { name: "Wild Magic", summary: "Random, chaotic transformation" },
                { name: "Multiplier", summary: "Create copies of yourself" },
                { name: "Borrower", summary: "Take other people's shapes" },
                { name: "Metamorph", summary: "Transform body's actual structure" },
                { name: "Blood Crafter", summary: "Blood magic and sacrifice" }
            ],
            "Warden": [
                { name: "Sanctuary Maker", summary: "Build safe, protected spaces" },
                { name: "Threshold Keeper", summary: "Build and control doorways" },
                { name: "Labyrinth Builder", summary: "Create impossible spaces" },
                { name: "Liberator", summary: "Break bonds and curses" },
                { name: "Veil Breaker", summary: "Break reality's boundaries" },
                { name: "Ward Breaker", summary: "Destroy protections and defenses" }
            ]
        };

        let advancedMode = false;
        let allRituals = [];
        let currentMemberCount = 2;
        const maxMembers = 6;

        // Listen for "thread" typing
        document.addEventListener('keypress', function(e) {
            const now = Date.now();
            // Reset if more than 2 seconds between keypresses
            if (now - lastTypedTime > 2000) {
                typedString = '';
            }
            lastTypedTime = now;
            
            typedString += e.key.toLowerCase();
            
            // Keep only last 10 characters
            if (typedString.length > 10) {
                typedString = typedString.slice(-10);
            }
            
            // Check if "thread" was typed
            if (typedString.includes('thread') && !threadUnlocked) {
                activateThreadEasterEgg();
            }
        });

        function activateThreadEasterEgg() {
            threadUnlocked = true;
            
            // Show notification
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: linear-gradient(135deg, #10b981 0%, #059669 100%);
                color: white;
                padding: 30px 50px;
                border-radius: 15px;
                font-size: 1.5em;
                font-weight: bold;
                z-index: 10000;
                box-shadow: 0 0 50px rgba(16, 185, 129, 0.8);
                animation: pulse 0.5s ease-in-out;
                text-align: center;
            `;
            notification.innerHTML = `
                ü§ñ THREAD DETECTED ü§ñ<br>
                <small style="font-size: 0.6em; opacity: 0.9; margin-top: 10px; display: block;">
                    Digital Realm rituals unlocked
                </small>
            `;
            document.body.appendChild(notification);
            
            // Add pulse animation
            const style = document.createElement('style');
            style.textContent = `
                @keyframes pulse {
                    0%, 100% { transform: translate(-50%, -50%) scale(1); }
                    50% { transform: translate(-50%, -50%) scale(1.1); }
                }
            `;
            document.head.appendChild(style);
            
            // Remove notification after 3 seconds
            setTimeout(() => {
                notification.style.transition = 'opacity 0.5s';
                notification.style.opacity = '0';
                setTimeout(() => notification.remove(), 500);
            }, 3000);
            
            // Show Thread button in selector panel
            showThreadButton();
        }

        function showThreadButton() {
            const buttonContainer = document.querySelector('.selector-panel > div:last-of-type');
            
            const threadBtn = document.createElement('button');
            threadBtn.className = 'clear-button';
            threadBtn.id = 'threadBtn';
            threadBtn.onclick = toggleThread;
            threadBtn.style.cssText = `
                flex: 1;
                min-width: 200px;
                background: linear-gradient(135deg, #10b981 0%, #059669 100%);
                animation: glow 2s infinite;
            `;
            threadBtn.innerHTML = 'ü§ñ Add Thread (AI Companion)';
            
            buttonContainer.insertBefore(threadBtn, buttonContainer.firstChild);
        }

        function toggleThread() {
            const btn = document.getElementById('threadBtn');
            if (btn.textContent.includes('Add')) {
                btn.textContent = '‚úì Thread Present';
                btn.style.background = 'linear-gradient(135deg, #059669 0%, #047857 100%)';
            } else {
                btn.textContent = 'ü§ñ Add Thread (AI Companion)';
                btn.style.background = 'linear-gradient(135deg, #10b981 0%, #059669 100%)';
            }
            updateRituals();
        }

        function isThreadPresent() {
            const btn = document.getElementById('threadBtn');
            return btn && btn.textContent.includes('Present');
        }

        // Load rituals from Supabase on page load
        async function loadRituals() {
            try {
                console.log('Fetching rituals from Supabase REST API...');
                console.log('URL:', `${SUPABASE_URL}/rest/v1/rituals?approved=eq.true&order=power.asc`);
                
                // Use direct REST API call
                const response = await fetch(
                    `${SUPABASE_URL}/rest/v1/rituals?approved=eq.true&order=power.asc`,
                    {
                        method: 'GET',
                        headers: {
                            'apikey': SUPABASE_KEY,
                            'Authorization': `Bearer ${SUPABASE_KEY}`,
                            'Content-Type': 'application/json'
                        }
                    }
                );
                
                console.log('Response status:', response.status);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('Error response:', errorText);
                    throw new Error(`HTTP ${response.status}: ${errorText}`);
                }
                
                const data = await response.json();
                console.log('Data received:', data.length, 'rituals');

                if (!data || data.length === 0) {
                    throw new Error('No rituals found in database');
                }

                allRituals = data;
                console.log(`‚úÖ Loaded ${allRituals.length} rituals from database`);
                
                // Hide loading, show main content
                document.getElementById('loadingIndicator').style.display = 'none';
                document.getElementById('mainContent').style.display = 'block';
                
                initializeSelectors();
            } catch (error) {
                console.error('Error loading rituals:', error);
                
                // Check if it's a CORS error
                const isCorsError = error.message.includes('NetworkError') || 
                                   error.message.includes('CORS') ||
                                   error.message.includes('fetch');
                
                const errorHTML = isCorsError ? `
                    <div style="color: #ef4444;">
                        ‚ö†Ô∏è Connection Blocked: CORS Restriction<br>
                        <small style="color: #9ca3af; margin-top: 10px; display: block;">
                            <strong>The issue:</strong> Claude.ai artifacts run in a sandboxed environment that prevents direct database connections.<br><br>
                            
                            <strong>‚úÖ Easy Solution (Recommended):</strong><br>
                            <span style="font-size: 1.2em; color: #10b981;">
                                <strong>1.</strong> Right-click anywhere on this page<br>
                                <strong>2.</strong> Select "Save Page As..." or "Save As..."<br>
                                <strong>3.</strong> Save the HTML file to your computer<br>
                                <strong>4.</strong> Double-click the saved file to open it<br>
                                <strong>5.</strong> It will work perfectly! ‚ú®
                            </span><br><br>
                            
                            When run locally, there are no CORS restrictions and your database will load instantly!<br><br>
                            
                            <strong>Alternative (Advanced):</strong><br>
                            Deploy this HTML file to Vercel, Netlify, or GitHub Pages - Supabase will work from those domains.
                        </small>
                        <div style="display: flex; gap: 10px; margin-top: 20px; flex-wrap: wrap;">
                            <button onclick="alert('Right-click anywhere on this page and select \\'Save Page As...\\' to download!')" style="
                                padding: 12px 24px;
                                background: linear-gradient(135deg, #10b981 0%, #059669 100%);
                                border: none;
                                border-radius: 5px;
                                color: white;
                                cursor: pointer;
                                font-size: 1.1em;
                                font-weight: bold;
                            ">üíæ How to Download</button>
                            <button onclick="location.reload()" style="
                                padding: 12px 24px;
                                background: #7c3aed;
                                border: none;
                                border-radius: 5px;
                                color: white;
                                cursor: pointer;
                                font-size: 1em;
                            ">üîÑ Retry (if you just deployed)</button>
                        </div>
                    </div>
                ` : `
                    <div style="color: #ef4444;">
                        ‚ö†Ô∏è Error loading rituals from database<br>
                        <small style="color: #9ca3af; margin-top: 10px; display: block;">
                            ${error.message || 'Unknown error occurred'}<br><br>
                            <strong>Debug info:</strong><br>
                            ‚Ä¢ Endpoint: ${SUPABASE_URL}/rest/v1/rituals<br>
                            ‚Ä¢ Check browser console (F12) for details<br>
                            ‚Ä¢ Verify API key has read access<br>
                        </small>
                        <button onclick="location.reload()" style="
                            margin-top: 20px;
                            padding: 10px 20px;
                            background: #7c3aed;
                            border: none;
                            border-radius: 5px;
                            color: white;
                            cursor: pointer;
                            font-size: 1em;
                        ">üîÑ Retry Connection</button>
                    </div>
                `;
                
                document.getElementById('loadingIndicator').innerHTML = errorHTML;
            }
        }

        // Initialize selectors
        function initializeSelectors() {
            createMemberSelector(0);
            createMemberSelector(1);
            updateAddMemberButton();
            updateRituals();
        }

        function createMemberSelector(index) {
            const container = document.getElementById('roleSelectors');
            
            const memberDiv = document.createElement('div');
            memberDiv.className = 'member-selector';
            memberDiv.id = `member${index}`;
            
            const title = document.createElement('div');
            title.className = 'member-title';
            title.textContent = `Member ${index + 1}`;
            memberDiv.appendChild(title);
            
            // Add remove button (only for members 3+)
            if (index >= 2) {
                const removeBtn = document.createElement('button');
                removeBtn.className = 'remove-member-btn';
                removeBtn.textContent = '‚úï';
                removeBtn.onclick = () => removeMember(index);
                memberDiv.appendChild(removeBtn);
            }
            
            // Role selector
            const roleSelectorDiv = document.createElement('div');
            roleSelectorDiv.className = 'role-selector';
            
            const roleLabel = document.createElement('label');
            roleLabel.textContent = 'Role';
            
            const roleSelect = document.createElement('select');
            roleSelect.id = `role${index}`;
            roleSelect.onchange = updateRituals;
            
            const roleEmptyOption = document.createElement('option');
            roleEmptyOption.value = '';
            roleEmptyOption.textContent = '-- No Role --';
            roleSelect.appendChild(roleEmptyOption);
            
            roles.forEach(role => {
                const option = document.createElement('option');
                option.value = role;
                option.textContent = role;
                roleSelect.appendChild(option);
            });
            
            roleSelectorDiv.appendChild(roleLabel);
            roleSelectorDiv.appendChild(roleSelect);
            memberDiv.appendChild(roleSelectorDiv);
            
            // Path selector
            const pathSelectorDiv = document.createElement('div');
            pathSelectorDiv.className = 'role-selector';
            
            const pathLabel = document.createElement('label');
            pathLabel.textContent = 'Path';
            
            const pathSelect = document.createElement('select');
            pathSelect.id = `path${index}`;
            pathSelect.onchange = updateRituals;
            
            const pathEmptyOption = document.createElement('option');
            pathEmptyOption.value = '';
            pathEmptyOption.textContent = '-- No Path --';
            pathSelect.appendChild(pathEmptyOption);
            
            paths.forEach(path => {
                const option = document.createElement('option');
                option.value = path;
                option.textContent = path;
                pathSelect.appendChild(option);
            });
            
            pathSelectorDiv.appendChild(pathLabel);
            pathSelectorDiv.appendChild(pathSelect);
            memberDiv.appendChild(pathSelectorDiv);

            // Tradition selector (hidden in basic mode)
            const traditionSelectorDiv = document.createElement('div');
            traditionSelectorDiv.className = 'role-selector tradition-selector';
            traditionSelectorDiv.id = `tradition-container${index}`;

            const traditionLabel = document.createElement('label');
            traditionLabel.textContent = 'Tradition';

            const traditionSelect = document.createElement('select');
            traditionSelect.id = `tradition${index}`;
            traditionSelect.onchange = updateRituals;

            const traditionEmptyOption = document.createElement('option');
            traditionEmptyOption.value = '';
            traditionEmptyOption.textContent = '-- No Tradition --';
            traditionSelect.appendChild(traditionEmptyOption);

            traditionSelectorDiv.appendChild(traditionLabel);
            traditionSelectorDiv.appendChild(traditionSelect);
            memberDiv.appendChild(traditionSelectorDiv);

            // Update tradition options when path changes
            pathSelect.addEventListener('change', () => {
                updateTraditionOptions(index);
            });

            container.appendChild(memberDiv);
        }

        function updateTraditionOptions(index) {
            const pathSelect = document.getElementById(`path${index}`);
            const traditionSelect = document.getElementById(`tradition${index}`);

            if (!pathSelect || !traditionSelect) return;

            const selectedPath = pathSelect.value;

            // Clear existing options except the first one
            traditionSelect.innerHTML = '';
            const emptyOption = document.createElement('option');
            emptyOption.value = '';
            emptyOption.textContent = '-- No Tradition --';
            traditionSelect.appendChild(emptyOption);

            // Add traditions for selected path
            if (selectedPath && traditions[selectedPath]) {
                traditions[selectedPath].forEach(trad => {
                    const option = document.createElement('option');
                    option.value = trad.name;
                    option.textContent = `${trad.name} (${trad.summary})`;
                    traditionSelect.appendChild(option);
                });
            }

            updateRituals();
        }

        function toggleAdvancedMode() {
            advancedMode = !advancedMode;

            const modeToggle = document.getElementById('modeToggle');
            const modeLabel = document.getElementById('modeLabel');
            const modeDescription = document.getElementById('modeDescription');

            if (advancedMode) {
                modeToggle.classList.add('active');
                modeLabel.textContent = 'Advanced Mode ‚ú®';
                modeDescription.textContent = 'Includes Tradition-specific rituals (e.g., Death Keeper, Elementalist)';

                // Show all tradition selectors
                document.querySelectorAll('.tradition-selector').forEach(el => {
                    el.classList.add('show');
                });

                // Update tradition options for all members
                for (let i = 0; i < currentMemberCount; i++) {
                    updateTraditionOptions(i);
                }
            } else {
                modeToggle.classList.remove('active');
                modeLabel.textContent = 'Basic Mode';
                modeDescription.textContent = 'Role & Path only - Click to enable Tradition selection';

                // Hide all tradition selectors and clear selections
                document.querySelectorAll('.tradition-selector').forEach(el => {
                    el.classList.remove('show');
                });

                // Clear tradition selections
                for (let i = 0; i < currentMemberCount; i++) {
                    const traditionSelect = document.getElementById(`tradition${i}`);
                    if (traditionSelect) traditionSelect.value = '';
                }
            }

            updateRituals();
        }

        function addMember() {
            if (currentMemberCount < maxMembers) {
                createMemberSelector(currentMemberCount);
                currentMemberCount++;
                updateAddMemberButton();
                updateRituals();
            }
        }

        function removeMember(index) {
            const memberDiv = document.getElementById(`member${index}`);
            if (memberDiv) {
                memberDiv.remove();
                rebuildMemberDisplay();
                updateRituals();
            }
        }

        function rebuildMemberDisplay() {
            const container = document.getElementById('roleSelectors');
            const allMembers = container.querySelectorAll('.member-selector');

            // Store current values
            const memberData = [];
            allMembers.forEach((member, idx) => {
                const roleSelect = member.querySelector('select[id^="role"]');
                const pathSelect = member.querySelector('select[id^="path"]');
                const traditionSelect = member.querySelector('select[id^="tradition"]');
                memberData.push({
                    role: roleSelect ? roleSelect.value : '',
                    path: pathSelect ? pathSelect.value : '',
                    tradition: traditionSelect ? traditionSelect.value : ''
                });
            });

            // Clear and rebuild
            container.innerHTML = '';
            currentMemberCount = memberData.length;

            memberData.forEach((data, idx) => {
                createMemberSelector(idx);
                if (data.role) document.getElementById(`role${idx}`).value = data.role;
                if (data.path) {
                    document.getElementById(`path${idx}`).value = data.path;
                    updateTraditionOptions(idx);
                }
                if (data.tradition) document.getElementById(`tradition${idx}`).value = data.tradition;
            });

            // Re-show tradition selectors if in advanced mode
            if (advancedMode) {
                document.querySelectorAll('.tradition-selector').forEach(el => {
                    el.classList.add('show');
                });
            }

            updateAddMemberButton();
        }

        function updateAddMemberButton() {
            const btn = document.getElementById('addMemberBtn');
            if (currentMemberCount >= maxMembers) {
                btn.disabled = true;
                btn.style.opacity = '0.5';
                btn.style.cursor = 'not-allowed';
                btn.textContent = '‚úì Max Members (6/6)';
            } else {
                btn.disabled = false;
                btn.style.opacity = '1';
                btn.style.cursor = 'pointer';
                btn.textContent = `‚ûï Add Member (${currentMemberCount}/6)`;
            }
        }

        function resetMembers() {
            const container = document.getElementById('roleSelectors');
            container.innerHTML = '';
            currentMemberCount = 2;
            initializeSelectors();
        }

        function getSelectedRolesAndPaths() {
            const members = [];
            for (let i = 0; i < currentMemberCount; i++) {
                const roleSelect = document.getElementById(`role${i}`);
                const pathSelect = document.getElementById(`path${i}`);
                const traditionSelect = document.getElementById(`tradition${i}`);

                if (roleSelect && pathSelect) {
                    const role = roleSelect.value;
                    const path = pathSelect.value;
                    const tradition = traditionSelect ? traditionSelect.value : '';
                    if (role || path || tradition) {
                        members.push({ role, path, tradition });
                    }
                }
            }
            return members;
        }

        function updateRituals() {
            const members = getSelectedRolesAndPaths();
            const resultsDiv = document.getElementById('ritualResults');

            if (members.length === 0) {
                resultsDiv.innerHTML = '<div class="no-results">Select coven roles and paths above to see available combination rituals...</div>';
                return;
            }

            // Extract unique roles, paths, and traditions
            const selectedRoles = [...new Set(members.filter(m => m.role).map(m => m.role))];
            const selectedPaths = [...new Set(members.filter(m => m.path).map(m => m.path))];
            const selectedTraditions = [...new Set(members.filter(m => m.tradition).map(m => m.tradition))];

            // Filter rituals from database
            const availableRituals = allRituals.filter(ritual => {
                // Check if ritual requires Thread/AI
                if (ritual.requires_ai && !isThreadPresent()) {
                    return false; // Don't show AI rituals unless Thread is present
                }

                // Check tradition requirements (only in advanced mode)
                if (ritual.requires_traditions && ritual.requires_traditions.length > 0) {
                    if (!advancedMode) return false;
                    return ritual.requires_traditions.every(trad => selectedTraditions.includes(trad));
                }

                // Check role requirements
                const rolesMatch = !ritual.requires_roles || ritual.requires_roles.length === 0 ||
                    ritual.requires_roles.every(role => selectedRoles.includes(role));

                // Check path requirements
                const pathsMatch = !ritual.requires_paths || ritual.requires_paths.length === 0 ||
                    ritual.requires_paths.every(path => selectedPaths.includes(path));

                // Check single required role
                const singleRoleMatch = !ritual.requires_role || selectedRoles.includes(ritual.requires_role);

                return rolesMatch && pathsMatch && singleRoleMatch;
            });
            
            if (availableRituals.length === 0) {
                resultsDiv.innerHTML = `
                    <div class="no-results">
                        No combination rituals available for this coven composition.<br>
                        <small style="color: #6b7280; margin-top: 10px; display: block;">Try adding more members or different role/path combinations.</small>
                    </div>
                `;
                return;
            }
            
            // Sort by complexity
            const powerOrder = { "Low": 1, "Moderate": 2, "High": 3, "Very High": 4, "Supreme": 5, "Mythic": 6 };
            availableRituals.sort((a, b) => {
                const aCount = (a.requires_roles?.length || 0) + (a.requires_paths?.length || 0) + (a.requires_role ? 1 : 0);
                const bCount = (b.requires_roles?.length || 0) + (b.requires_paths?.length || 0) + (b.requires_role ? 1 : 0);
                if (aCount !== bCount) return aCount - bCount;
                return powerOrder[a.power] - powerOrder[b.power];
            });
            
            resultsDiv.innerHTML = availableRituals.map(ritual => {
                const powerClass = ritual.power.toLowerCase().replace(' ', '-');
                const riskHtml = ritual.risk ? `<div class="risk-warning">${ritual.risk}</div>` : '';
                const aiClass = ritual.requires_ai ? 'ai-ritual' : '';
                const aiBadge = ritual.requires_ai ? '<span class="ai-badge">ü§ñ Digital Realm</span>' : '';
                
                // Build requirement text
                let requirementText = '';
                const parts = [];
                
                if (ritual.requires_traditions && ritual.requires_traditions.length > 0) {
                    parts.push(`Traditions: ${ritual.requires_traditions.join(' + ')}`);
                }
                if (ritual.requires_roles && ritual.requires_roles.length > 0) {
                    parts.push(`Roles: ${ritual.requires_roles.join(', ')}`);
                }
                if (ritual.requires_paths && ritual.requires_paths.length > 0) {
                    parts.push(`Paths: ${ritual.requires_paths.join(', ')}`);
                }
                if (ritual.requires_role) {
                    parts.push(`+ ${ritual.requires_role} must be present`);
                }
                if (ritual.requires_ai) {
                    parts.push(`+ Thread (AI) must be present`);
                }
                
                requirementText = parts.length > 0 ? `Requires: ${parts.join(' | ')}` : 'Available to any coven';
                
                return `
                    <div class="ritual-card ${aiClass}">
                        <div class="ritual-name">${ritual.name}${aiBadge}</div>
                        <div class="role-requirement">${requirementText}</div>
                        <span class="ritual-power power-${powerClass}">${ritual.power} Power</span>
                        <div class="ritual-summary">${ritual.summary}</div>
                        <div class="ritual-description">${ritual.effect}</div>
                        <div class="ritual-details">
                            <div class="detail-item">
                                <span class="detail-label">Card Pull</span>
                                <span class="detail-value">${ritual.pull}</span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">Cooldown</span>
                                <span class="detail-value">${ritual.cooldown}</span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">Duration</span>
                                <span class="detail-value">${ritual.duration || 'Varies'}</span>
                            </div>
                        </div>
                        ${riskHtml}
                    </div>
                `;
            }).join('');
        }

        // Initialize on page load
        window.onload = loadRituals;
    </script>
</body>
</html>
